{"version":3,"sources":["tester/data-sources/xAPI/api.ts","../node_modules/ws/browser.js"],"names":["debug","Debug","addr","applySearchterm","symbols","keyword","filter","symbol","includes","name","searchSymbol","keywords","a","ws","WebSocket","Promise","resolve","reject","addEventListener","msg","command","arguments","userId","password","send","JSON","stringify","undefined","data","parse","streamSessionId","close","returnData","map","obj","type","currency","error","normalizeCandles","candles","scale","candle","date","open","high","low","volume","moment","toDate","since","Map","set","getCandles","period","info","Number","start","subtract","get","valueOf","strin","rateInfos","Math","pow","digits","module","exports","Error"],"mappings":"0TAaMA,EAAQC,IAAM,QAgBdC,EALe,wBAqBjBC,EAAkB,SAASC,EAA2BC,GACxD,OAAOD,EAAQE,QAAO,SAAAC,GACpB,OAAOA,EAAOA,OAAOC,SAASH,IAAYE,EAAOE,KAAKD,SAASH,OAI/DK,EAAY,uCAAG,WAAgBC,GAAhB,eAAAC,EAAA,6DACXC,EAAgB,IAAIC,IAAUZ,GADnB,kBAGV,IAAIa,SAAQ,SAACC,EAASC,GAC3BJ,EAAGK,iBAAiB,QAAQ,WAE1B,IAAIC,EAAgB,CAAEC,QAAS,QAASC,UAAW,CAAEC,OA1B3C,EA0B4DC,SAzB3D,MA0BXV,EAAGW,KAAKC,KAAKC,UAAUP,OAEzBN,EAAGK,iBAAiB,UAApB,uCAA+B,WAAOC,GAAP,iBAAAP,EAAA,2DAGAe,KADvBC,EAAOH,KAAKI,MAAMV,EAAIS,OACnBE,iBAEHX,EAAwB,CAAEC,QAAS,iBACvCP,EAAGW,KAAKC,KAAKC,UAAUP,MAGvBN,EAAGkB,QACHf,EAAQb,EAAiCyB,EAAKI,WAnCrCC,KAAI,SAAA1B,GACjB,IAAI2B,EAAiB,CAAE3B,OAAQ,GAAIE,KAAM,GAAI0B,KAAM,GAAIC,SAAU,IAKjE,OAJAF,EAAI3B,OAASA,EAAM,OACnB2B,EAAIzB,KAAOF,EAAM,YACjB2B,EAAIC,KAAO5B,EAAM,aACjB2B,EAAIE,SAAW7B,EAAM,SACd2B,KA6BwDvB,KAVhC,2CAA/B,uDAaAE,EAAGK,iBAAiB,SAAS,eAG7BL,EAAGK,iBAAiB,QAAQ,WAC1BlB,EAAM,4BAA8BE,EAAO,QAE7CW,EAAGK,iBAAiB,SAAS,SAACmB,WA5Bf,2CAAH,sDAkCZC,EAAmB,SAAUC,EAAmCC,GAClE,OAAOD,EAAQN,KAAI,SAAAQ,GACjB,IAAIP,EAAiB,CAAEQ,KAAM,EAAGC,KAAM,EAAGC,KAAM,EAAGC,IAAK,EAAGd,MAAO,EAAGe,OAAQ,GAS5E,OAPAZ,EAAIQ,KAAOK,IAAON,EAAM,KAASO,SACjCd,EAAIS,KAAOF,EAAM,KAAWD,EAC5BN,EAAIU,KAAOV,EAAIS,KAAOF,EAAM,KAAWD,EACvCN,EAAIW,IAAMX,EAAIS,KAAOF,EAAM,IAAUD,EACrCN,EAAIH,MAAQG,EAAIS,KAAOF,EAAM,MAAYD,EACzCN,EAAIY,OAASL,EAAM,IAEZP,MAILe,EAAQ,IAAIC,IAClBD,EAAME,IAAI,EAAG,GACbF,EAAME,IAAI,EAAG,GACbF,EAAME,IAAI,GAAI,GACdF,EAAME,IAAI,GAAI,GACdF,EAAME,IAAI,GAAI,GACdF,EAAME,IAAI,IAAK,IACfF,EAAME,IAAI,KAAM,IAChBF,EAAME,IAAI,MAAO,IACjBF,EAAME,IAAI,MAAO,IAEjB,IAAIC,EAAU,uCAAG,WAAgB7C,EAAgB8C,GAAhC,eAAAzC,EAAA,6DACTC,EAAgB,IAAIC,IAAUZ,GADrB,kBAGR,IAAIa,SAAQ,SAACC,EAASC,GAC3BJ,EAAGK,iBAAiB,QAAQ,WAE1B,IAAIC,EAAgB,CAAEC,QAAS,QAASC,UAAW,CAAEC,OAtF3C,EAsF4DC,SArF3D,MAsFXV,EAAGW,KAAKC,KAAKC,UAAUP,OAEzBN,EAAGK,iBAAiB,UAApB,uCAA+B,WAAOC,GAAP,mBAAAP,EAAA,2DAGAe,KADvBC,EAAOH,KAAKI,MAAMV,EAAIS,OACnBE,iBAEHX,EAA2B,CAAEC,QAAS,sBAAuBC,UAAW,CAAEiC,KAAM,CAAED,OAAQE,OAAOF,GAASG,MAAOT,MAASU,SAASR,EAAMS,IAAIH,OAAOF,IAAU,SAASM,UAAWpD,OAAQA,KAC1LqD,EAAQnC,KAAKC,UAAUP,GAC3BnB,EAAM,QAAS4D,GACf/C,EAAGW,KAAKoC,KAGR/C,EAAGkB,QACHf,EAAQsB,EAAiBV,EAAKI,WAAW6B,UAAWC,KAAKC,IAAI,GAAInC,EAAKI,WAAWgC,WAZtD,2CAA/B,uDAeAnD,EAAGK,iBAAiB,SAAS,eAG7BL,EAAGK,iBAAiB,QAAQ,WAC1BlB,EAAM,4BAA8BE,EAAO,QAE7CW,EAAGK,iBAAiB,SAAS,SAACmB,WA9BjB,2CAAH,yD,iCC7Gd4B,EAAOC,QAAU,WACf,MAAM,IAAIC,MAAM","file":"static/js/4.bdd8bb23.chunk.js","sourcesContent":["// GENERAL DEPENDENCIES\r\nimport WebSocket from 'ws'\r\n\r\n// DEBUGGING\r\nimport Debug from 'debug'\r\n\r\n\r\n// ARBITER DEPENDENCIES\r\n//import { logger } from '../../logger'\r\n//import * as eventHandler from '../../event-handler'\r\nimport * as i from '../../interfaces'\r\nimport moment from 'moment';\r\n\r\nconst debug = Debug('xapi')\r\nconst HOST = 'https://xapi.xtb.com';\r\nconst DEMO_PORTS = {\r\n  MAIN: 5124,\r\n  STREAM: 5125\r\n};\r\nconst REAL_PORTS = {\r\n  MAIN: 5112,\r\n  STREAM: 5113\r\n};\r\n\r\nconst ADDRESS_DEMO = 'wss://ws.xtb.com/demo';\r\nconst ADDRESS_DEMO_STREAM = 'wss://ws.xtb.com/demoStream';\r\nconst ADDRESS_REAL = 'wss://ws.xtb.com/real';\r\nconst ADDRESS_REAL_STREAM = 'wss://ws.xtb.com/realStream';\r\n\r\nconst addr = ADDRESS_DEMO;\r\n\r\nconst USER_ID = 0;//nconf.get('xapi:user_id');\r\nconst PASSWORD = '0';//nconf.get('xapi:password');\r\n\r\nlet normalizeSymbols = function (symbols: Array<i.ISymbolRecord>) {\r\n  return symbols.map(symbol => {\r\n    let obj: i.ISymbol = { symbol: '', name: '', type: '', currency: '' };\r\n    obj.symbol = symbol['symbol'];\r\n    obj.name = symbol['description'];\r\n    obj.type = symbol['categoryName'];\r\n    obj.currency = symbol['currency'];\r\n    return obj;\r\n  });\r\n}\r\n\r\nlet applySearchterm = function(symbols: Array<i.ISymbol>, keyword: string) {\r\n  return symbols.filter(symbol => {\r\n    return symbol.symbol.includes(keyword) || symbol.name.includes(keyword);\r\n  });\r\n}\r\n\r\nlet searchSymbol = async function (keywords: string) {\r\n  const ws: WebSocket = new WebSocket(addr);\r\n\r\n  return new Promise((resolve, reject) => {\r\n    ws.addEventListener('open', () => {\r\n      //logger.info('Websocket opened for [' + addr + ']');\r\n      let msg: i.ILogin = { command: \"login\", arguments: { userId: USER_ID, password: PASSWORD } };\r\n      ws.send(JSON.stringify(msg));\r\n    });\r\n    ws.addEventListener('message', async (msg: any) => {\r\n      //debug('message from ws: %O', msg.data);\r\n      const data = JSON.parse(msg.data);\r\n      if (data.streamSessionId !== undefined) {\r\n        //logger.info('Websocket logged in; sending \"getAllSymbols\"...');\r\n        let msg: i.IGetAllSymbols = { command: \"getAllSymbols\" };\r\n        ws.send(JSON.stringify(msg));\r\n      } else {\r\n        //logger.info('Websocket \"getAllSymbols\" result received, returning it...');\r\n        ws.close();\r\n        resolve(applySearchterm(normalizeSymbols(data.returnData), keywords));\r\n      }\r\n    });\r\n    ws.addEventListener('close', () => {\r\n      //logger.info('Websocket closed for [' + addr + ']');\r\n    });\r\n    ws.addEventListener('ping', () => {\r\n      debug('Webocket ping received! [' + addr + ']');\r\n    });\r\n    ws.addEventListener('error', (error: any) => {\r\n      //logger.error('Websocket error for [' + addr + ']', error);\r\n    });\r\n  });\r\n}\r\n\r\nlet normalizeCandles = function (candles: Array<i.IRateInfoRecord>, scale: number) {\r\n  return candles.map(candle => {\r\n    let obj: i.ICandle = { date: 0, open: 0, high: 0, low: 0, close: 0, volume: 0 };\r\n\r\n    obj.date = moment(candle['ctm']).toDate();\r\n    obj.open = candle['open'] / scale;\r\n    obj.high = obj.open + candle['high'] / scale;\r\n    obj.low = obj.open + candle['low'] / scale;\r\n    obj.close = obj.open + candle['close'] / scale;\r\n    obj.volume = candle['vol'];\r\n\r\n    return obj;\r\n  });\r\n}\r\n\r\nconst since = new Map();\r\nsince.set(1, 1);\r\nsince.set(5, 1);\r\nsince.set(15, 1);\r\nsince.set(30, 7);\r\nsince.set(60, 7);\r\nsince.set(240, 13);\r\nsince.set(1440, 13);\r\nsince.set(10080, 60);\r\nsince.set(43200, 60);\r\n\r\nlet getCandles = async function (symbol: string, period: number) {\r\n  const ws: WebSocket = new WebSocket(addr);\r\n\r\n  return new Promise((resolve, reject) => {\r\n    ws.addEventListener('open', () => {\r\n      //logger.info('Websocket opened for [' + addr + ']');\r\n      let msg: i.ILogin = { command: \"login\", arguments: { userId: USER_ID, password: PASSWORD } };\r\n      ws.send(JSON.stringify(msg));\r\n    });\r\n    ws.addEventListener('message', async (msg: any) => {\r\n      //debug('message from ws: %O', msg.data);\r\n      const data = JSON.parse(msg.data);\r\n      if (data.streamSessionId !== undefined) {\r\n        //logger.info('Websocket logged in; sending \"getChartLastRequest\"...');\r\n        let msg: i.IChartLastRequest = { command: \"getChartLastRequest\", arguments: { info: { period: Number(period), start: moment().subtract(since.get(Number(period)), 'month').valueOf(), symbol: symbol } } };\r\n        let strin = JSON.stringify(msg);\r\n        debug('Strin', strin);\r\n        ws.send(strin);\r\n      } else {\r\n        //logger.info('Websocket \"getChartLastRequest\" result received, returning it...');\r\n        ws.close();\r\n        resolve(normalizeCandles(data.returnData.rateInfos, Math.pow(10, data.returnData.digits)));\r\n      }\r\n    });\r\n    ws.addEventListener('close', () => {\r\n      //logger.info('Websocket closed for [' + addr + ']');\r\n    });\r\n    ws.addEventListener('ping', () => {\r\n      debug('Webocket ping received! [' + addr + ']');\r\n    });\r\n    ws.addEventListener('error', (error: any) => {\r\n      //logger.error('Websocket error for [' + addr + ']', error);\r\n    });\r\n  });\r\n}\r\n\r\nexport {\r\n  searchSymbol,\r\n  getCandles\r\n}","'use strict';\n\nmodule.exports = function () {\n  throw new Error('ws does not work in the browser. Browser clients must use the native ' + 'WebSocket object');\n};"],"sourceRoot":""}